define(["jquery","underscore","qlik","client.utils/state","./lib/external/d3/d3.v4.min","./lib/external/lodash/lodash","./properties","./initialproperties","./lib/external/sense-extension-utils/general-utils","general.utils/responsive-state","objects.utils/num-date-time-formatter","general.utils/number-formatting","text!./lib/partials/template.html","text!./lib/partials/tooltip-template.html","text!./lib/css/style.css","text!./lib/css/climber-icons.css","text!themes/old/sense/theme.json"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){"use strict";return i.addStyleToHeader(o),i.addStyleToHeader(p),{definition:g,initialProperties:h,snapshot:{canTakeSnapshot:!0},support:{"export":!0},resize:function(a,b){this.paint(a,b)},template:m,thinHeader:!0,controller:["$scope",function(f){f.infinityReplacementChar="-";var g=c.currApp();f.localeInfo=g?g.model.layout.qLocaleInfo:{qDecimalSep:",",qThousandSep:" "},f.DEFAULT_AUTO_FORMAT="0A",f.initNumberFormatter=function(){f.numberFormatter=new k(f.localeInfo,f.DEFAULT_AUTO_FORMAT,f.localeInfo.qThousandSep,f.localeInfo.qDecimalSep,"U"),f.DEFAULT_AUTO_FORMAT=f.numberFormatter.createPatternFromRange(0,1,!0)},f.isSmallDevice=j.isSmallDevice,f.showOverlay=!1,f.scales={},f.theme=JSON.parse(q),f.color={background:f.theme.backgroundColor,defaultBlendFactor:.3},f.showIcon=function(){var a=!f.options.showIconWithTitle&&!f.options.hideIcon;return a},f.showIconWithTitle=function(){var a=f.options.showIconWithTitle&&!f.options.hideIcon;return a},f.getSentimentFromValues=function(a){var b,c=a.value01-a.value02;b="3-colors"===a.colorMode&&a.comparisionIsRelative?a.banding/100*a.value02:"3-colors"!==a.colorMode||a.comparisionIsRelative?0:a.banding;var d=c>=0?1:-1;return"less_is_better"===a.comparisonType&&(d=-d),0!==b&&("more_is_better"===a.comparisonType&&-c>0&&b>-c?d=0:"less_is_better"===a.comparisonType&&c>0&&b>c&&(d=0)),d},f.getColor=function(a,b,c){var d=1;if("argb("===a.substring(0,5).toLowerCase()){var g=a.substr(5,a.length-6).split(",");4===g.length&&(d=g[0]/255,a="rgba("+g[1]+","+g[2]+","+g[3]+","+d+")")}if(b&&void 0===c)return e.color(e.interpolateRgb(f.color.background,e.rgb(a))(f.color.defaultBlendFactor*d)).toString();if(b&&void 0!==c)return e.color(e.interpolateRgb(f.color.background,e.rgb(a))(c*d)).toString();if(c>=0&&!b){var h=e.rgb(a);return h.opacity=c*d,h.toString()}return e.color(a).toString()},f.options={},f.gotoSheet=function(){!b.isEmpty(f.options.sheetId)&&d.isInAnalysisMode()&&(f.doActionBeforeNavigation(),c.navigation.gotoSheet(f.options.sheetId))},f.setVariable=function(a,d){if(!b.isEmpty(a)&&!b.isEmpty(d)){var e=c.currApp();e.variable.setContent(a,d)}},f.selectValueInField=function(a,d){if(!b.isEmpty(a)&&!b.isEmpty(d)){var e=c.currApp();e.field(a).selectMatch(d,!1)}},f.splitToStringNum=function(a,b){for(var c=a.split(b),d=0;d<c.length;d++)isNaN(c[d])||(c[d]=Number(c[d]));return c},f.getValuesArrayFromStringWithSeparator=function(a,c){var d=b.map(a.split(c),function(a){var b=a.trim();return isNaN(b)?b:Number(b)});return JSON.stringify(d)},f.selectValuesInField=function(a,d,e){if(!b.isEmpty(a)&&!b.isEmpty(d)){var g=c.currApp(),h=f.getValuesArrayFromStringWithSeparator(d,e);g.field(a).selectValues(h,!1)["catch"](function(a){})}},f.clearSelectionsInField=function(a){if(!b.isEmpty(a)){var d=c.currApp();d.field(a).clear()["catch"](function(a){})}},f.doActionBeforeNavigation=function(){switch(f.options.navigation.actionBeforeNavigation){case"clearSelectionsInField":f.clearSelectionsInField(f.options.navigation.field);break;case"selectValueInField":f.selectValueInField(f.options.navigation.field,f.options.navigation.value);break;case"selectValuesInField":f.selectValuesInField(f.options.navigation.field,f.options.navigation.values,f.options.navigation.valuesSeparator);break;case"setVariable":f.setVariable(f.options.navigation.variable,f.options.navigation.variableValue)}},f.formatValue=function(a,b){return a?(f.numberFormatter.pattern=b,f.numberFormatter.format(+a).replace("Infinity",f.infinityReplacementChar)):""},f.mouseover=function(){(f.options.navigation.mode||f.options.showDetails)&&(f.showOverlay=!0)},f.mouseout=function(){(f.options.navigation.mode||f.options.showDetails)&&(f.showOverlay=!1)},f.updateTooltip=function(b,c,d,e){var g,h=b.x-f.options.margins.left;g=h<=d.range()[0]?0:h>=d.range()[1]?d.domain().length-1:Math.round(h/(d.range()[1]-d.range()[0])*(d.domain().length-1));var i=f.options.transformedData[0].values[g],j=2===f.options.transformedData.length,k=j?f.options.transformedData[1].values[g]:{},l="",m="rgb(255,255,255)";if(f.options.inTargetMode&&!f.options.targetColorModeIsExpression){f.options.comparisionIsRelative?(l=f.formatValue(k.y.value<0?1-i.y.value/k.y.value:i.y.value/k.y.value-1,f.options.formats.comparison),""===l&&(l="0%")):l=f.formatValue(i.y.value-k.y.value,f.options.formats.comparison);var o={value01:i.y.value,value02:k.y.value,comparisonType:f.options.comparison.type,comparisionIsRelative:f.options.comparisionIsRelative,banding:f.options.comparison.banding,colorMode:f.options.comparison.colorMode},p=f.getSentimentFromValues(o);1===p?m=f.options.comparison.colors.good:0===p?m=f.options.comparison.colors.goodEnough:-1===p&&(m=f.options.comparison.colors.bad)}var q=8;f.tooltip.style("max-width",a(window).width()-q+"px").html(n);var r=a("div.cl-tooltip"),s=[];f.options.trend.showZerosAsGaps&&"NaN"===i.y.value&&j?(l="",s.push(k)):(s.push(i),j&&s.push(k)),r.find(".cl-tooltip__dimension-label").html(s[0].x.text),r.find(".cl-tooltip__kpi-color").css("background-color",s[0].colorMarker),r.find(".cl-tooltip__kpi-cell").html(s[0].y.text),f.options.inTargetMode&&""!==l?(r.find(".cl-tooltip__comparision-cell").html(l),r.find(".cl-tooltip__comparision-cell").css("color",m)):r.find(".cl-tooltip__comparision-cell").remove(),s.length>1?(r.find(".cl-tooltip__target-color").css("background-color",s[1].colorMarker),r.find(".cl-tooltip__target-cell").html(s[1].y.text)):r.find(".cl-tooltip__target-row").remove();var t=r.outerWidth(),u=r.outerHeight(),v={element:{x:c.x-b.x,y:c.y-b.y}};v.point={x:v.element.x+f.options.margins.left+d(s[0].x.text),y:v.element.y+f.options.margins.top+f.options.trendChartOffsetY+e(s[0].y.value)},"bar"===f.options.transformedData[0].type&&(v.point.x+=d.bandwidth()/2);var w=8,x=-2;if(a(".cl-tooltip").length){var y=window.getComputedStyle(document.querySelector(".cl-tooltip"),":after");w=Number(y.getPropertyValue("border-bottom-width").replace("px",""))+Number(y.getPropertyValue("border-top-width").replace("px","")),x=-w/4}var z=u+w+2,A=t/2,B=x+f.options.margins.left/2;v.point.x<t/2?(A=v.point.x,A+=-B):a(window).width()-v.point.x<t/2&&(A=t-(a(window).width()-v.point.x),A+=B),0===a("#cl-tooltip").length&&a("<style type='text/css' id='cl-tooltip' />").appendTo("head"),a("#cl-tooltip").text(".cl-tooltip:after{left:"+A+"px;}"),f.tooltip.style("left",v.point.x-A+"px").style("top",v.point.y-z+"px").style("display","inline-block")},f.$watch("$parent.layout.props.animate",function(a){f.options.animate=a}),f.$on("$destroy",function(){a("div.cl-tooltip").remove()})}],paint:function(a,d){void 0!==d.props.canTakeSnapshot&&(this.$scope.$parent.ext.snapshot.canTakeSnapshot=d.props.canTakeSnapshot);var g=this,h=function(){return 1===d.qHyperCube.qDimensionInfo.length},i=function(){return d.props.target.mode&&d.qHyperCube.qMeasureInfo.length>=2},j=function(){return d.props.layout.color.mode},m=function(a){var b="#"+a.toString(16).substr(2);return b.length>4?b:!1},n=function(a){var b="#"+a.toString(16).substr(2);return b.length>4?parseInt(a.toString(16).substr(0,2),16)/255:1},o=function(a){var b=e.rgb(m(a));return b.opacity=n(a),b.toString()},p=function(a,b,c){var d=.7,e=.6;"large"===c&&(d=.65,e=.55);var f=a>b?b*d:a*e;return f+"px"},q=function(a){if(a.qHyperCube.qGrandTotalRow.length<2)return void 0;if("byExpression"===a.props.color.target.mode)return a.props.iconDirectionExpression;var b={value01:a.qHyperCube.qGrandTotalRow[0].qNum,value02:a.qHyperCube.qGrandTotalRow[1].qNum,comparisonType:a.props.target.comparisonType,comparisionMode:a.props.target.comparison,comparisionIsRelative:"relative"===a.props.target.comparison?!0:!1,banding:a.props.target.banding,colorMode:a.props.color.target.mode};return g.$scope.getSentimentFromValues(b)},r=function(a){if("byExpression"===a.props.color.target.mode)return a.props.color.colorExpressions.target;var b=q(a);return 1===b?a.props.color.customColors.good.color:0===b?a.props.color.customColors.goodEnough.color:-1===b?a.props.color.customColors.bad.color:void 0},s=function(a){var b,c="cl-icon-"+a.props.target.icon.slice(0,-3),d=q(a);b=-1===d?c+"-down":1===d?c+"-up":c+"-right";var e={icon:b};return e},t=function(a){return i()?s(a):{icon:"cl-icon-"+a.props.icon}},u=function(a){var b={background:a.props.color.customColors.background.color,icon:a.props.color.customColors.icon.color,targetTrend:a.props.color.customColors.targetTrend.color,text:a.props.color.customColors.text.color,trend:a.props.color.customColors.trend.color};return"byExpression"===a.props.color.other.mode&&(b.background=a.props.color.colorExpressions.background,b.text=a.props.color.colorExpressions.text,b.iconAndTrend=a.props.color.colorExpressions.iconAndTrend),"byExpression"===a.props.color.icon.mode&&(b.icon=g.$scope.getColor(a.props.color.colorExpressions.icon)),"byExpression"===a.props.color.trend.mode&&(b.trend=g.$scope.getColor(a.props.color.colorExpressions.trend)),b},v=function(a){var b=u(a),c={navigation:g.$scope.getColor(a.props.color.overlay.navigationColor.color),overlay:g.$scope.getColor(a.props.color.overlay.bgcolor.color,!1,a.props.color.overlay.opacity),text:g.$scope.getColor(b.text),background:"",icon:"",targetTrend:"",targetTrendMarker:"",targetTrendLegend:"",trend:"",trendMarker:"",trendLegend:""};return i()?(b.target=r(a),j()?c.background=g.$scope.getColor(b.target):b.icon=b.target):j()&&(c.background=g.$scope.getColor(b.background)),g.$scope.color.background=j()?c.background:g.$scope.theme.backgroundColor,c.icon=g.$scope.getColor(b.icon),h()&&(a.props.color.trend.iconIndependence||(b.trend=b.icon),a.props.color.trend.autoblend?(c.trend=g.$scope.getColor(b.trend,!1,g.$scope.color.defaultBlendFactor),c.trendMarker=g.$scope.getColor(b.trend,!0,g.$scope.color.defaultBlendFactor)):(c.trend=g.$scope.getColor(b.trend,!1,a.props.color.trend.blendFactor),c.trendMarker=g.$scope.getColor(b.trend,!0,a.props.color.trend.blendFactor)),a.props.color.targetTrend.autoblend?(c.targetTrend=g.$scope.getColor(b.targetTrend,!1,g.$scope.color.defaultBlendFactor),c.targetTrendMarker=g.$scope.getColor(b.targetTrend,!0,g.$scope.color.defaultBlendFactor)):(c.targetTrend=g.$scope.getColor(b.targetTrend,!1,a.props.color.targetTrend.blendFactor),c.targetTrendMarker=g.$scope.getColor(b.targetTrend,!0,a.props.color.targetTrend.blendFactor)),c.trendLegend=b.trend,c.targetTrendLegend=b.targetTrend),c},w=function(a,b,c){var d={small:12,medium:10,large:9},e={small:6,medium:4,large:3};c=d[c]?c:"medium";var f=a/d[c],g=b/e[c],h=f>g?g:f;return h+"px"},x=function(a){var b={one:3,two:7,three:2,four:2};return"comparisonFocus"===a.textLayoutMode?b.two=5:"comparison"===a.textLayoutMode&&(b.two=5,b.three=4),b};if("relative"!==d.props.target.comparison&&d.qHyperCube.qMeasureInfo.length>0){var y=l.getNormalizedFormat(d.qHyperCube.qMeasureInfo[0].qNumFormat,d.qHyperCube.qMeasureInfo[0].qNumFormat.qFmt),z=d.qHyperCube.qMeasureInfo[0].qNumFormat.qType,A="",B="";["D","T","TS","IV"].indexOf(z)<0&&(A=d.qHyperCube.qMeasureInfo[0].qNumFormat.qThou,B=d.qHyperCube.qMeasureInfo[0].qNumFormat.qDec),g.$scope.numberFormatter=new k(g.$scope.localeInfo,y,A,B,z)}else g.$scope.initNumberFormatter();var C={id:d.qInfo.qId,animate:d.props.animate,comparisionIsRelative:"relative"===d.props.target.comparison,showTooltip:h()&&"tooltip"===d.props.hoverMode,showDetails:"details"===d.props.hoverMode,showIconWithTitle:d.props.showIconWithTitle?!0:!1,hideKpiLabel:d.props.hideKpiLabel,hideTargetLabel:d.props.hideTargetLabel,hideIcon:d.props.hideIcon||"icon"===d.props.backgroundImageMode,showBackgroundImage:"url"===d.props.backgroundImageMode||"contentlibrary"===d.props.backgroundImageMode,showBackgroundIcon:"icon"===d.props.backgroundImageMode&&!d.props.hideIcon,backgroundImageUrl:"contentlibrary"===d.props.backgroundImageMode?encodeURI(".."+d.props.backgroundContentLibraryImage):d.props.backgroundImageURL,backgroundImageSizeMode:d.props.backgroundImageSizeMode,inTargetMode:i(),targetColorModeIsExpression:"byExpression"===d.props.color.target.mode,comparison:{type:d.props.target.comparisonType,banding:d.props.target.banding,colorMode:d.props.color.target.mode,colors:{good:d.props.color.customColors.good.color,goodEnough:d.props.color.customColors.goodEnough.color,bad:d.props.color.customColors.bad.color}},hoverMode:d.props.hoverMode,hidethirdmeasure:d.props.hidethirdmeasure,sheetId:d.props.sheetId,navigation:{mode:"navigation"===d.props.hoverMode,showButton:d.props.navigation.showButton,text:d.props.navigation.text,actionBeforeNavigation:d.props.actionBeforeNavigation,field:d.props.field.replace(/\=/g,""),value:d.props.value,values:d.props.values,valuesSeparator:d.props.valuesSeparatorComma?",":d.props.valuesSeparatorCustom,variable:d.props.variable,variableValue:d.props.variableValue},labels:{},measures:{},formats:{},domains:{},trend:{},icons:t(d),color:v(d),textSize:d.props.layout.textSize,textWeight:d.props.layout.boldText?"bold":"normal",align:d.props.kpiAlign,layoutMode:d.props.layout.mode,textLayoutMode:d.props.target.layout.mode,size:{height:a.height(),width:a.width()},marginType:d.props.layout.marginType?d.props.layout.marginType:"default"};C.backgroundIconSize=p(a.width(),a.height(),C.marginType);var D={"default":{top:8,bottom:8,left:8,right:8},none:{top:0,bottom:0,left:0,right:0},large:{top:16,bottom:16,left:16,right:16}},E={"default":{left:0,right:0},none:{left:8,right:8},large:{left:0,right:0}};if(C.trendChartOffsetY=0,C.margins=b.clone(D[C.marginType]),C.padding=b.clone(E[C.marginType]),C.size.innerHeight=C.size.height-C.margins.top-C.margins.bottom,C.size.innerWidth=C.size.width-C.margins.left-C.margins.right,C.size.textWrapperHeight=C.size.innerHeight,C.size.textWrapperWidth=C.size.innerWidth-C.padding.left-C.padding.right,"top"===d.props.layout.mode&&(C.size.innerHeight=.5*C.size.innerHeight+C.margins.top,C.size.textWrapperHeight=.5*C.size.textWrapperHeight+C.margins.bottom,C.trendChartOffsetY=C.size.textWrapperHeight-C.margins.bottom-C.margins.top),C.blockSizes=x(C),h()&&(C.trend={chartType:d.qHyperCube.qDimensionInfo[0].trend.chartType,targetChartType:d.qHyperCube.qDimensionInfo[0].trend.showTargetTrend?d.qHyperCube.qDimensionInfo[0].trend.targetChartType:"",showDatapoints:d.qHyperCube.qDimensionInfo[0].trend.showDatapoints,showTargetDatapoints:d.qHyperCube.qDimensionInfo[0].trend.showTargetDatapoints,showZerosAsGaps:d.qHyperCube.qDimensionInfo[0].trend.showZerosAsGaps}),i()){var F;"relative"===d.props.target.comparison?(C.formats.comparison="0%",1===d.props.target.precision&&(C.formats.comparison="0"+g.$scope.localeInfo.qDecimalSep+"0%"),2===d.props.target.precision&&(C.formats.comparison="0"+g.$scope.localeInfo.qDecimalSep+"00%"),F=d.qHyperCube.qGrandTotalRow[0].qNum/d.qHyperCube.qGrandTotalRow[1].qNum-1,C.measures.comparison=g.$scope.formatValue(F,C.formats.comparison)):(C.formats.comparison=d.qHyperCube.qMeasureInfo[0].qIsAutoFormat?g.$scope.DEFAULT_AUTO_FORMAT:d.qHyperCube.qMeasureInfo[0].qNumFormat.qFmt,F=d.qHyperCube.qGrandTotalRow[0].qNum-d.qHyperCube.qGrandTotalRow[1].qNum,C.measures.comparison=g.$scope.formatValue(F,C.formats.comparison))}if(d.qHyperCube.qMeasureInfo.length>0?(C.labels.kpi=""===d.props.kpiLabel?d.qHyperCube.qMeasureInfo[0].qFallbackTitle:d.props.kpiLabel,C.measures.kpi=d.qHyperCube.qMeasureInfo[0].qIsAutoFormat?g.$scope.formatValue(d.qHyperCube.qGrandTotalRow[0].qNum,g.$scope.DEFAULT_AUTO_FORMAT):d.qHyperCube.qGrandTotalRow[0].qText,C.formats.kpi=d.qHyperCube.qMeasureInfo[0].qIsAutoFormat?g.$scope.DEFAULT_AUTO_FORMAT:d.qHyperCube.qMeasureInfo[0].qNumFormat.qFmt):C.noMeasures=!0,d.qHyperCube.qMeasureInfo.length>1&&(C.labels.target=""===d.props.targetLabel?d.qHyperCube.qMeasureInfo[1].qFallbackTitle:d.props.targetLabel,C.labels.comparison=i()?d.props.target.comparisonLabel:"",C.labels.target=""!==C.labels.comparison?d.props.target.comparisonLabel:C.labels.target,C.measures.target=d.qHyperCube.qGrandTotalRow[1]?d.qHyperCube.qMeasureInfo[1].qIsAutoFormat?g.$scope.formatValue(d.qHyperCube.qGrandTotalRow[1].qNum,g.$scope.DEFAULT_AUTO_FORMAT):d.qHyperCube.qGrandTotalRow[1].qText:"",C.formats.target=d.qHyperCube.qMeasureInfo[1]&&d.qHyperCube.qMeasureInfo[1].qIsAutoFormat?g.$scope.DEFAULT_AUTO_FORMAT:d.qHyperCube.qMeasureInfo[1]?d.qHyperCube.qMeasureInfo[1].qNumFormat.qFmt:g.$scope.DEFAULT_AUTO_FORMAT),C.fontsize=w(C.size.textWrapperWidth,C.size.textWrapperHeight,C.textSize),C.fontsizeOverlay=w(C.size.textWrapperWidth,C.size.height-C.margins.top-C.margins.bottom,C.textSize),this.$scope.options=C,a.find(".trendchart").empty(),h()){C.transformedData=f.compact(b.map(d.qHyperCube.qMeasureInfo,function(a,c){if(3!==d.qHyperCube.qMeasureInfo.length||1!==c){var e=0===c,f=e?C.color.trend:C.color.targetTrend,h=e?C.color.trendMarker:C.color.targetTrendMarker,i=a.qIsAutoFormat?g.$scope.DEFAULT_AUTO_FORMAT:void 0,j=e?C.trend.chartType:C.trend.targetChartType,k=!1,l=b.map(d.qHyperCube.qDataPages[0].qMatrix,function(b){var e={x:{text:b[0].qText},y:{text:i?g.$scope.formatValue(b[c+1].qNum,i):b[c+1].qText,value:b[c+1].qNum},id:c,color:f,colorMarker:h};if(a.colorizeDatapoint&&b[c+1].qAttrExps&&"NaN"!==b[c+1].qAttrExps.qValues[0].qNum&&("bar"===j||"marker"===j))e.color=o(b[c+1].qAttrExps.qValues[0].qNum),e.colorMarker=e.color;else if(b[1].qNum&&b.length>2&&b[2].qNum&&(2===c&&!d.qHyperCube.qMeasureInfo[1].colorizeSetByExpression&&d.qHyperCube.qMeasureInfo[1].colorizeDatapoint||a.colorizeDatapoint&&!d.qHyperCube.qMeasureInfo[c].colorizeSetByExpression)){var k={value01:b[1].qNum,value02:b[2].qNum,comparisonType:g.$scope.options.comparison.type,comparisionIsRelative:g.$scope.options.comparisionIsRelative,banding:g.$scope.options.comparison.banding,colorMode:g.$scope.options.comparison.colorMode},l=g.$scope.getSentimentFromValues(k);1===l?(e.color=g.$scope.getColor(g.$scope.options.comparison.colors.good,!0),e.colorMarker=g.$scope.options.comparison.colors.good):0===l?(e.color=g.$scope.getColor(g.$scope.options.comparison.colors.goodEnough,!0),e.colorMarker=g.$scope.options.comparison.colors.goodEnough):-1===l&&(e.color=g.$scope.getColor(g.$scope.options.comparison.colors.bad,!0),e.colorMarker=g.$scope.options.comparison.colors.bad)}return C.trend.showZerosAsGaps&&0===c&&0===e.y.value&&(e.y.value="NaN"),e});1===l.length&&(e?"area"===j?j="bar":"line"===j&&(j="marker"):""!==j&&(j="marker")),"marker"===j?k=!0:"line"===j&&(k=e?C.trend.showDatapoints:C.trend.showTargetDatapoints);var m={id:c,type:j,values:l,showDatapoints:k,color:f,colorMarker:h};return m}})),C.domains.x=b.map(d.qHyperCube.qDataPages[0].qMatrix,function(a){return a[0].qText});var G=e.select(a.get(0)).select(".trendchart").append("svg").attr("width",C.size.width).attr("height",C.size.height),H=G.selectAll("g").data([C.transformedData]).enter().append("g").attr("transform","translate("+C.margins.left+","+(C.margins.top+C.trendChartOffsetY)+")"),I=e.scaleBand().range([0,C.size.innerWidth]).paddingInner(.2).paddingOuter(0);I.domain(C.domains.x);var J="bar"===C.trend.chartType?I.bandwidth()/2:0,K=e.scalePoint().range([0+J,C.size.innerWidth-J]);K.domain(C.domains.x);var L=e.scaleLinear().range([C.size.innerHeight,0]),M=[],N=[],O=d.qHyperCube.qDimensionInfo[0].measureAxis.min,P=d.qHyperCube.qDimensionInfo[0].measureAxis.max,Q=d.qHyperCube.qMeasureInfo[0].qMax<0?0:d.qHyperCube.qMeasureInfo[0].qMax,R=d.qHyperCube.qMeasureInfo[0].qMin,S=d.qHyperCube.qMeasureInfo.length-1,T=d.qHyperCube.qMeasureInfo[S].qMax,U=d.qHyperCube.qMeasureInfo[S].qMin,V=d.qHyperCube.qDimensionInfo[0].measureAxis.minMax;if("minMax"===V&&O>P){var W=O;O=P,P=W}d.qHyperCube.qDimensionInfo[0].measureAxis.autoMinMax||"auto"===V?(N.push(Q),M.push(R),""!==C.trend.targetChartType&&d.qHyperCube.qMeasureInfo.length>1&&(N.push(T),M.push(U))):"min"===V?(M.push(O),N.push(Q),""!==C.trend.targetChartType&&d.qHyperCube.qMeasureInfo.length>1&&N.push(T)):"max"===V?(N.push(P),M.push(R),""!==C.trend.targetChartType&&d.qHyperCube.qMeasureInfo.length>1&&M.push(U)):"minMax"===V&&(M.push(O),N.push(P)),L.domain([e.min(M),e.max(N)]),d.qHyperCube.qDimensionInfo[0].measureAxis.autoMinMax&&L.nice(),g.$scope.scales.x=K,g.$scope.scales.xBar=I,g.$scope.scales.y=L;var X=0;L.domain()[0]>0&&L.domain()[1]>0?X=L.domain()[0]:L.domain()[0]<0&&L.domain()[1]<0&&(X=L.domain()[1]);var Y=e.area().defined(function(a){return"NaN"!==a.y.value}).curve(e.curveLinear).x(function(a){return K(a.x.text)}).y0(L(X)).y1(function(a){return L(a.y.value)}),Z=e.line().defined(function(a){return"NaN"!==a.y.value}).curve(e.curveLinear).x(function(a){return K(a.x.text)}).y(function(a){return L(a.y.value)}),$=H.selectAll(".trendchart__series").data(function(a){return a}).enter().append("g").attr("class",function(a){return"trendchart__series trendchart__series--"+a.id});$.filter(function(a){return"line"===a.type}).append("path").attr("class","trendchart__line").attr("d",function(a){return Z(a.values)}).style("stroke",function(a){return a.color}).style("stroke-opacity",function(a){return a.opacity}).style("fill","none"),$.filter(function(a){return a.showDatapoints}).selectAll("g.trendchart__circles").data(function(a){return[a]}).enter().append("g").attr("class","trendchart__circles").selectAll("marker").data(function(a){return a.values}).enter().filter(function(a){return"NaN"!==a.y.value}).append("circle").attr("class","trendchart__circle").attr("r",4).attr("cx",function(a){return K(a.x.text)}).attr("cy",function(a){return L(a.y.value)}).style("fill",function(a){return a.colorMarker}),$.filter(function(a){return"area"===a.type}).append("path").attr("class","trendchart__area").attr("d",function(a){return Y(a.values)}).style("fill",function(a){return a.color}),$.filter(function(a){return"bar"===a.type}).selectAll("g.trendchart__bars").data(function(a){return[a]}).enter().append("g").attr("class","trendchart__bars").selectAll("bar").data(function(a){return a.values}).enter().filter(function(a){return"NaN"!==a.y.value}).append("rect").attr("class","trendchart__bar").attr("x",function(a){return I(a.x.text)}).attr("width",I.bandwidth()).attr("y",function(a){return L(Math.max(0,a.y.value))}).attr("height",function(a){return Math.abs(L(a.y.value)-L(0))}).style("fill",function(a){return a.color});var _=e.select("body").selectAll("div.cl-tooltip").data(["tooltip"]);_.enter().append("div").attr("class","cl-tooltip").style("opacity",0),_.exit().remove(),g.$scope.tooltip=e.select("body").select("div.cl-tooltip"),e.select(a.get(0)).select(".kpi-interaction-layer").on("mouseover",function(){g.$scope.options.showTooltip&&(g.$scope.tooltip.transition().style("opacity",.9),g.$scope.updateTooltip({x:e.mouse(this)[0],y:e.mouse(this)[1]},{x:e.event.pageX,y:e.event.pageY},"bar"===C.trend.chartType?I:K,L))}).on("mousemove",function(){g.$scope.options.showTooltip&&g.$scope.updateTooltip({x:e.mouse(this)[0],y:e.mouse(this)[1]},{x:e.event.pageX,y:e.event.pageY},"bar"===C.trend.chartType?I:K,L)}).on("mouseout",function(){g.$scope.options.showTooltip&&g.$scope.tooltip.transition().style("opacity",0)})}return g.$scope.options=C,c.Promise.resolve()}}});