define(["jquery","underscore","qlik","client.utils/state","./lib/external/d3/d3.v4.min","./lib/external/lodash/lodash","./properties","./initialproperties","./lib/external/sense-extension-utils/general-utils","general.utils/responsive-state","objects.utils/num-date-time-formatter","general.utils/number-formatting","text!./lib/partials/template.html","text!./lib/partials/tooltip-template.html","text!./lib/css/style.css","text!./lib/css/climber-icons.css","text!themes/old/sense/theme.json"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){"use strict";return i.addStyleToHeader(o),i.addStyleToHeader(p),{definition:g,initialProperties:h,snapshot:{canTakeSnapshot:!0},support:{"export":!1},resize:function(a,b){this.paint(a,b)},template:m,thinHeader:!0,controller:["$scope",function(f){f.infinityReplacementChar="-";var g=c.currApp();f.localeInfo=g.model.layout.qLocaleInfo,f.DEFAULT_AUTO_FORMAT="0A",f.initNumberFormatter=function(){f.numberFormatter=new k(f.localeInfo,f.DEFAULT_AUTO_FORMAT,f.localeInfo.qThousandSep,f.localeInfo.qDecimalSep,"U"),f.DEFAULT_AUTO_FORMAT=f.numberFormatter.createPatternFromRange(0,1,!0)},f.isSmallDevice=j.isSmallDevice,f.showOverlay=!1,f.scales={},f.theme=JSON.parse(q),f.color={background:f.theme.backgroundColor,defaultBlendFactor:.3},f.showIcon=function(){var a=!f.options.showIconWithTitle&&!f.options.hideIcon;return a},f.showIconWithTitle=function(){var a=f.options.showIconWithTitle&&!f.options.hideIcon;return a},f.getSentimentFromValues=function(a){var b,c=a.value01-a.value02;b="3-colors"===a.colorMode&&a.comparisionIsRelative?a.banding/100*a.value02:"3-colors"!==a.colorMode||a.comparisionIsRelative?0:a.banding;var d=c>=0?1:-1;return"less_is_better"===a.comparisonType&&(d=-d),0!==b&&("more_is_better"===a.comparisonType&&-c>=0&&b>-c?d=0:"less_is_better"===a.comparisonType&&c>=0&&b>c&&(d=0)),d},f.getColor=function(a,b,c){var d=1;if("argb("===a.substring(0,5).toLowerCase()){var g=a.substr(5,a.length-6).split(",");4===g.length&&(d=g[0]/255,a="rgba("+g[1]+","+g[2]+","+g[3]+","+d+")")}if(b&&void 0===c)return e.color(e.interpolateRgb(f.color.background,e.rgb(a))(f.color.defaultBlendFactor*d)).toString();if(b&&void 0!==c)return e.color(e.interpolateRgb(f.color.background,e.rgb(a))(c*d)).toString();if(c>=0&&!b){var h=e.rgb(a);return h.opacity=c*d,h.toString()}return e.color(a).toString()},f.options={},f.gotoSheet=function(){!b.isEmpty(f.options.sheetId)&&d.isInAnalysisMode()&&(f.doActionBeforeNavigation(),c.navigation.gotoSheet(f.options.sheetId))},f.setVariable=function(a,d){if(!b.isEmpty(a)&&!b.isEmpty(d)){var e=c.currApp();e.variable.setContent(a,d)}},f.selectValueInField=function(a,d){if(!b.isEmpty(a)&&!b.isEmpty(d)){var e=c.currApp();e.field(a).selectMatch(d,!1)}},f.splitToStringNum=function(a,b){for(var c=a.split(b),d=0;d<c.length;d++)isNaN(c[d])||(c[d]=Number(c[d]));return c},f.getValuesArrayFromStringWithSeparator=function(a,c){var d=b.map(a.split(c),function(a){var b=a.trim();return isNaN(b)?b:Number(b)});return JSON.stringify(d)},f.selectValuesInField=function(a,d,e){if(!b.isEmpty(a)&&!b.isEmpty(d)){var g=c.currApp(),h=f.getValuesArrayFromStringWithSeparator(d,e);g.field(a).selectValues(h,!1)["catch"](function(a){})}},f.clearSelectionsInField=function(a){if(!b.isEmpty(a)){var d=c.currApp();d.field(a).clear()["catch"](function(a){})}},f.doActionBeforeNavigation=function(){switch(f.options.navigation.actionBeforeNavigation){case"clearSelectionsInField":f.clearSelectionsInField(f.options.navigation.field);break;case"selectValueInField":f.selectValueInField(f.options.navigation.field,f.options.navigation.value);break;case"selectValuesInField":f.selectValuesInField(f.options.navigation.field,f.options.navigation.values,f.options.navigation.valuesSeparator);break;case"setVariable":f.setVariable(f.options.navigation.variable,f.options.navigation.variableValue)}},f.formatValue=function(a,b){return a?(f.numberFormatter.pattern=b,f.numberFormatter.format(+a).replace("Infinity",f.infinityReplacementChar)):""},f.mouseover=function(){(f.options.navigation.mode||f.options.showDetails)&&(f.showOverlay=!0)},f.mouseout=function(){(f.options.navigation.mode||f.options.showDetails)&&(f.showOverlay=!1)},f.updateTooltip=function(b,c,d,e){var g,h=b.x-f.options.margins.left;g=h<=d.range()[0]?0:h>=d.range()[1]?d.domain().length-1:Math.round(h/(d.range()[1]-d.range()[0])*(d.domain().length-1));var i=f.options.transformedData[0].values[g],j=2===f.options.transformedData.length,k=j?f.options.transformedData[1].values[g]:{},l="",m="rgb(255,255,255)";if(f.options.inTargetMode&&!f.options.targetColorModeIsExpression){f.options.comparisionIsRelative?(l=f.formatValue(k.y.value<0?1-i.y.value/k.y.value:i.y.value/k.y.value-1,f.options.formats.comparison),""===l&&(l="0%")):l=f.formatValue(i.y.value-k.y.value,f.options.formats.comparison);var o={value01:i.y.value,value02:k.y.value,comparisonType:f.options.comparison.type,comparisionIsRelative:f.options.comparisionIsRelative,banding:f.options.comparison.banding,colorMode:f.options.comparison.colorMode},p=f.getSentimentFromValues(o);1===p?m=f.options.comparison.colors.good:0===p?m=f.options.comparison.colors.goodEnough:-1===p&&(m=f.options.comparison.colors.bad)}var q=8;f.tooltip.style("max-width",a(window).width()-q+"px").html(n);var r=a("div.cl-tooltip"),s=[];f.options.trend.showZerosAsGaps&&"NaN"===i.y.value&&j?(l="",s.push(k)):(s.push(i),j&&s.push(k)),r.find(".cl-tooltip__dimension-label").html(s[0].x.text),r.find(".cl-tooltip__kpi-color").css("background-color",s[0].colorMarker),r.find(".cl-tooltip__kpi-cell").html(s[0].y.text),f.options.inTargetMode&&""!==l?(r.find(".cl-tooltip__comparision-cell").html(l),r.find(".cl-tooltip__comparision-cell").css("color",m)):r.find(".cl-tooltip__comparision-cell").remove(),s.length>1?(r.find(".cl-tooltip__target-color").css("background-color",s[1].colorMarker),r.find(".cl-tooltip__target-cell").html(s[1].y.text)):r.find(".cl-tooltip__target-row").remove();var t=r.outerWidth(),u=r.outerHeight(),v={element:{x:c.x-b.x,y:c.y-b.y}};v.point={x:v.element.x+f.options.margins.left+d(s[0].x.text),y:v.element.y+f.options.margins.top+f.options.trendChartOffsetY+e(s[0].y.value)},"bar"===f.options.transformedData[0].type&&(v.point.x+=d.bandwidth()/2);var w=8,x=-2;if(a(".cl-tooltip").length){var y=window.getComputedStyle(document.querySelector(".cl-tooltip"),":after");w=Number(y.getPropertyValue("border-bottom-width").replace("px",""))+Number(y.getPropertyValue("border-top-width").replace("px","")),x=-w/4}var z=u+w+2,A=t/2,B=x+f.options.margins.left/2;v.point.x<t/2?(A=v.point.x,A+=-B):a(window).width()-v.point.x<t/2&&(A=t-(a(window).width()-v.point.x),A+=B),0===a("#cl-tooltip").length&&a("<style type='text/css' id='cl-tooltip' />").appendTo("head"),a("#cl-tooltip").text(".cl-tooltip:after{left:"+A+"px;}"),f.tooltip.style("left",v.point.x-A+"px").style("top",v.point.y-z+"px").style("display","inline-block")},f.$watch("$parent.layout.props.animate",function(a){f.options.animate=a}),f.$on("$destroy",function(){a("div.cl-tooltip").remove()})}],paint:function(a,c){void 0!==c.props.canTakeSnapshot&&(this.$scope.$parent.ext.snapshot.canTakeSnapshot=c.props.canTakeSnapshot);var d=this,g=function(){return 1===c.qHyperCube.qDimensionInfo.length},h=function(){return c.props.target.mode&&c.qHyperCube.qMeasureInfo.length>=2},i=function(){return c.props.layout.color.mode},j=function(a){var b="#"+a.toString(16).substr(2);return b.length>4?b:!1},m=function(a){var b="#"+a.toString(16).substr(2);return b.length>4?parseInt(a.toString(16).substr(0,2),16)/255:1},n=function(a){var b=e.rgb(j(a));return b.opacity=m(a),b.toString()},o=function(a,b,c){var d=.7,e=.6;"large"===c&&(d=.65,e=.55);var f=a>b?b*d:a*e;return f+"px"},p=function(a){if(a.qHyperCube.qGrandTotalRow.length<2)return void 0;if("byExpression"===a.props.color.target.mode)return a.props.iconDirectionExpression;var b={value01:a.qHyperCube.qGrandTotalRow[0].qNum,value02:a.qHyperCube.qGrandTotalRow[1].qNum,comparisonType:a.props.target.comparisonType,comparisionMode:a.props.target.comparison,banding:a.props.target.banding,colorMode:a.props.color.target.mode};return d.$scope.getSentimentFromValues(b)},q=function(a){if("byExpression"===a.props.color.target.mode)return a.props.color.colorExpressions.target;var b=p(a);return 1===b?a.props.color.customColors.good.color:0===b?a.props.color.customColors.goodEnough.color:-1===b?a.props.color.customColors.bad.color:void 0},r=function(a){var b="cl-icon-"+a.props.target.icon.slice(0,-3),c=p(a),d={icon:-1===c?b+"-down":b+"-up"};return 0===c&&(d.icon2=b+"-down"),d},s=function(a){return h()?r(a):{icon:"cl-icon-"+a.props.icon}},t=function(a){var b={background:a.props.color.customColors.background.color,icon:a.props.color.customColors.icon.color,targetTrend:a.props.color.customColors.targetTrend.color,text:a.props.color.customColors.text.color,trend:a.props.color.customColors.trend.color};return"byExpression"===a.props.color.other.mode&&(b.background=a.props.color.colorExpressions.background,b.text=a.props.color.colorExpressions.text,b.iconAndTrend=a.props.color.colorExpressions.iconAndTrend),"byExpression"===a.props.color.icon.mode&&(b.icon=d.$scope.getColor(a.props.color.colorExpressions.icon)),"byExpression"===a.props.color.trend.mode&&(b.trend=d.$scope.getColor(a.props.color.colorExpressions.trend)),b},u=function(a){var b=t(a),c={navigation:d.$scope.getColor(a.props.color.overlay.navigationColor.color),overlay:d.$scope.getColor(a.props.color.overlay.bgcolor.color,!1,a.props.color.overlay.opacity),text:d.$scope.getColor(b.text),background:"",icon:"",targetTrend:"",targetTrendMarker:"",targetTrendLegend:"",trend:"",trendMarker:"",trendLegend:""};return h()?(b.target=q(a),i()?c.background=d.$scope.getColor(b.target):b.icon=b.target):i()&&(c.background=d.$scope.getColor(b.background)),d.$scope.color.background=i()?c.background:d.$scope.theme.backgroundColor,c.icon=d.$scope.getColor(b.icon),g()&&(a.props.color.trend.iconIndependence||(b.trend=b.icon),a.props.color.trend.autoblend?(c.trend=d.$scope.getColor(b.trend,!1,d.$scope.color.defaultBlendFactor),c.trendMarker=d.$scope.getColor(b.trend,!0,d.$scope.color.defaultBlendFactor)):(c.trend=d.$scope.getColor(b.trend,!1,a.props.color.trend.blendFactor),c.trendMarker=d.$scope.getColor(b.trend,!0,a.props.color.trend.blendFactor)),a.props.color.targetTrend.autoblend?(c.targetTrend=d.$scope.getColor(b.targetTrend,!1,d.$scope.color.defaultBlendFactor),c.targetTrendMarker=d.$scope.getColor(b.targetTrend,!0,d.$scope.color.defaultBlendFactor)):(c.targetTrend=d.$scope.getColor(b.targetTrend,!1,a.props.color.targetTrend.blendFactor),c.targetTrendMarker=d.$scope.getColor(b.targetTrend,!0,a.props.color.targetTrend.blendFactor)),c.trendLegend=b.trend,c.targetTrendLegend=b.targetTrend),c},v=function(a,b,c){var d={small:12,medium:10,large:9},e={small:6,medium:4,large:3};c=d[c]?c:"medium";var f=a/d[c],g=b/e[c],h=f>g?g:f;return h+"px"},w=function(a){var b={one:3,two:7,three:2,four:2};return"comparisonFocus"===a.textLayoutMode?b.two=5:"comparison"===a.textLayoutMode&&(b.two=5,b.three=4),b};if("relative"!==c.props.target.comparison&&c.qHyperCube.qMeasureInfo.length>0){var x=l.getNormalizedFormat(c.qHyperCube.qMeasureInfo[0].qNumFormat,c.qHyperCube.qMeasureInfo[0].qNumFormat.qFmt),y=c.qHyperCube.qMeasureInfo[0].qNumFormat.qType,z="",A="";["D","T","TS","IV"].indexOf(y)<0&&(z=c.qHyperCube.qMeasureInfo[0].qNumFormat.qThou,A=c.qHyperCube.qMeasureInfo[0].qNumFormat.qDec),d.$scope.numberFormatter=new k(d.$scope.localeInfo,x,z,A,y)}else d.$scope.initNumberFormatter();var B={id:c.qInfo.qId,animate:c.props.animate,comparisionIsRelative:"relative"===c.props.target.comparison,showTooltip:g()&&"tooltip"===c.props.hoverMode,showDetails:"details"===c.props.hoverMode,showIconWithTitle:c.props.showIconWithTitle?!0:!1,hideKpiLabel:c.props.hideKpiLabel,hideTargetLabel:c.props.hideTargetLabel,hideIcon:c.props.hideIcon||"icon"===c.props.backgroundImageMode,showBackgroundImage:"url"===c.props.backgroundImageMode||"contentlibrary"===c.props.backgroundImageMode,showBackgroundIcon:"icon"===c.props.backgroundImageMode&&!c.props.hideIcon,backgroundImageUrl:"contentlibrary"===c.props.backgroundImageMode?encodeURI(".."+c.props.backgroundContentLibraryImage):c.props.backgroundImageURL,backgroundImageSizeMode:c.props.backgroundImageSizeMode,inTargetMode:h(),targetColorModeIsExpression:"byExpression"===c.props.color.target.mode,comparison:{type:c.props.target.comparisonType,banding:c.props.target.banding,colorMode:c.props.color.target.mode,colors:{good:c.props.color.customColors.good.color,goodEnough:c.props.color.customColors.goodEnough.color,bad:c.props.color.customColors.bad.color}},hoverMode:c.props.hoverMode,hidethirdmeasure:c.props.hidethirdmeasure,sheetId:c.props.sheetId,navigation:{mode:"navigation"===c.props.hoverMode,showButton:c.props.navigation.showButton,text:c.props.navigation.text,actionBeforeNavigation:c.props.actionBeforeNavigation,field:c.props.field,value:c.props.value,values:c.props.values,valuesSeparator:c.props.valuesSeparatorComma?",":c.props.valuesSeparatorCustom,variable:c.props.variable,variableValue:c.props.variableValue},labels:{},measures:{},formats:{},domains:{},trend:{},icons:s(c),color:u(c),textSize:c.props.layout.textSize,textWeight:c.props.layout.boldText?"bold":"normal",align:c.props.kpiAlign,layoutMode:c.props.layout.mode,textLayoutMode:c.props.target.layout.mode,size:{height:a.height(),width:a.width()},marginType:c.props.layout.marginType?c.props.layout.marginType:"default"};B.backgroundIconSize=o(a.width(),a.height(),B.marginType);var C={"default":{top:8,bottom:8,left:8,right:8},none:{top:0,bottom:0,left:0,right:0},large:{top:16,bottom:16,left:16,right:16}},D={"default":{left:0,right:0},none:{left:8,right:8},large:{left:0,right:0}};if(B.trendChartOffsetY=0,B.margins=b.clone(C[B.marginType]),B.padding=b.clone(D[B.marginType]),B.size.innerHeight=B.size.height-B.margins.top-B.margins.bottom,B.size.innerWidth=B.size.width-B.margins.left-B.margins.right,B.size.textWrapperHeight=B.size.innerHeight,B.size.textWrapperWidth=B.size.innerWidth-B.padding.left-B.padding.right,"top"===c.props.layout.mode&&(B.size.innerHeight=.5*B.size.innerHeight+B.margins.top,B.size.textWrapperHeight=.5*B.size.textWrapperHeight+B.margins.bottom,B.trendChartOffsetY=B.size.textWrapperHeight-B.margins.bottom-B.margins.top),B.blockSizes=w(B),g()&&(B.trend={chartType:c.qHyperCube.qDimensionInfo[0].trend.chartType,targetChartType:c.qHyperCube.qDimensionInfo[0].trend.showTargetTrend?c.qHyperCube.qDimensionInfo[0].trend.targetChartType:"",showDatapoints:c.qHyperCube.qDimensionInfo[0].trend.showDatapoints,showTargetDatapoints:c.qHyperCube.qDimensionInfo[0].trend.showTargetDatapoints,showZerosAsGaps:c.qHyperCube.qDimensionInfo[0].trend.showZerosAsGaps}),h()){var E;"relative"===c.props.target.comparison?(B.formats.comparison="0%",1===c.props.target.precision&&(B.formats.comparison="0"+d.$scope.localeInfo.qDecimalSep+"0%"),2===c.props.target.precision&&(B.formats.comparison="0"+d.$scope.localeInfo.qDecimalSep+"00%"),E=c.qHyperCube.qGrandTotalRow[0].qNum/c.qHyperCube.qGrandTotalRow[1].qNum-1,B.measures.comparison=d.$scope.formatValue(E,B.formats.comparison)):(B.formats.comparison=c.qHyperCube.qMeasureInfo[0].qIsAutoFormat?d.$scope.DEFAULT_AUTO_FORMAT:c.qHyperCube.qMeasureInfo[0].qNumFormat.qFmt,E=c.qHyperCube.qGrandTotalRow[0].qNum-c.qHyperCube.qGrandTotalRow[1].qNum,B.measures.comparison=d.$scope.formatValue(E,B.formats.comparison))}if(c.qHyperCube.qMeasureInfo.length>0?(B.labels.kpi=""===c.props.kpiLabel?c.qHyperCube.qMeasureInfo[0].qFallbackTitle:c.props.kpiLabel,B.measures.kpi=c.qHyperCube.qMeasureInfo[0].qIsAutoFormat?d.$scope.formatValue(c.qHyperCube.qGrandTotalRow[0].qNum,d.$scope.DEFAULT_AUTO_FORMAT):c.qHyperCube.qGrandTotalRow[0].qText,B.formats.kpi=c.qHyperCube.qMeasureInfo[0].qIsAutoFormat?d.$scope.DEFAULT_AUTO_FORMAT:c.qHyperCube.qMeasureInfo[0].qNumFormat.qFmt):B.noMeasures=!0,c.qHyperCube.qMeasureInfo.length>1&&(B.labels.target=""===c.props.targetLabel?c.qHyperCube.qMeasureInfo[1].qFallbackTitle:c.props.targetLabel,B.labels.comparison=h()?c.props.target.comparisonLabel:"",B.labels.target=""!==B.labels.comparison?c.props.target.comparisonLabel:B.labels.target,B.measures.target=c.qHyperCube.qGrandTotalRow[1]?c.qHyperCube.qMeasureInfo[1].qIsAutoFormat?d.$scope.formatValue(c.qHyperCube.qGrandTotalRow[1].qNum,d.$scope.DEFAULT_AUTO_FORMAT):c.qHyperCube.qGrandTotalRow[1].qText:"",B.formats.target=c.qHyperCube.qMeasureInfo[1]&&c.qHyperCube.qMeasureInfo[1].qIsAutoFormat?d.$scope.DEFAULT_AUTO_FORMAT:c.qHyperCube.qMeasureInfo[1]?c.qHyperCube.qMeasureInfo[1].qNumFormat.qFmt:d.$scope.DEFAULT_AUTO_FORMAT),B.fontsize=v(B.size.textWrapperWidth,B.size.textWrapperHeight,B.textSize),B.fontsizeOverlay=v(B.size.textWrapperWidth,B.size.height-B.margins.top-B.margins.bottom,B.textSize),this.$scope.options=B,a.find(".trendchart").empty(),g()){B.transformedData=f.compact(b.map(c.qHyperCube.qMeasureInfo,function(a,e){if(3!==c.qHyperCube.qMeasureInfo.length||1!==e){var f=0===e,g=f?B.color.trend:B.color.targetTrend,h=f?B.color.trendMarker:B.color.targetTrendMarker,i=a.qIsAutoFormat?d.$scope.DEFAULT_AUTO_FORMAT:void 0,j=f?B.trend.chartType:B.trend.targetChartType,k=!1,l=b.map(c.qHyperCube.qDataPages[0].qMatrix,function(b){var f={x:{text:b[0].qText},y:{text:i?d.$scope.formatValue(b[e+1].qNum,i):b[e+1].qText,value:b[e+1].qNum},id:e,color:g,colorMarker:h};if(a.colorizeDatapoint&&b[e+1].qAttrExps&&"NaN"!==b[e+1].qAttrExps.qValues[0].qNum&&("bar"===j||"marker"===j))f.color=n(b[e+1].qAttrExps.qValues[0].qNum),f.colorMarker=f.color;else if(b[1].qNum&&b[2].qNum&&(2===e&&!c.qHyperCube.qMeasureInfo[1].colorizeSetByExpression&&c.qHyperCube.qMeasureInfo[1].colorizeDatapoint||a.colorizeDatapoint&&!c.qHyperCube.qMeasureInfo[e].colorizeSetByExpression)){var k={value01:b[1].qNum,value02:b[2].qNum,comparisonType:d.$scope.options.comparison.type,comparisionIsRelative:d.$scope.options.comparisionIsRelative,banding:d.$scope.options.comparison.banding,colorMode:d.$scope.options.comparison.colorMode},l=d.$scope.getSentimentFromValues(k);1===l?(f.color=d.$scope.getColor(d.$scope.options.comparison.colors.good,!0),f.colorMarker=d.$scope.options.comparison.colors.good):0===l?(f.color=d.$scope.getColor(d.$scope.options.comparison.colors.goodEnough,!0),f.colorMarker=d.$scope.options.comparison.colors.goodEnough):-1===l&&(f.color=d.$scope.getColor(d.$scope.options.comparison.colors.bad,!0),f.colorMarker=d.$scope.options.comparison.colors.bad)}return B.trend.showZerosAsGaps&&0===e&&0===f.y.value&&(f.y.value="NaN"),f});1===l.length&&(f?"area"===j?j="bar":"line"===j&&(j="marker"):""!==j&&(j="marker")),"marker"===j?k=!0:"line"===j&&(k=f?B.trend.showDatapoints:B.trend.showTargetDatapoints);var m={id:e,type:j,values:l,showDatapoints:k,color:g,colorMarker:h};return m}})),B.domains.x=b.map(c.qHyperCube.qDataPages[0].qMatrix,function(a){return a[0].qText});var F=e.select(a.get(0)).select(".trendchart").append("svg").attr("width",B.size.width).attr("height",B.size.height),G=F.selectAll("g").data([B.transformedData]).enter().append("g").attr("transform","translate("+B.margins.left+","+(B.margins.top+B.trendChartOffsetY)+")"),H=e.scaleBand().range([0,B.size.innerWidth]).paddingInner(.2).paddingOuter(0);H.domain(B.domains.x);var I="bar"===B.trend.chartType?H.bandwidth()/2:0,J=e.scalePoint().range([0+I,B.size.innerWidth-I]);J.domain(B.domains.x);var K=e.scaleLinear().range([B.size.innerHeight,0]),L=[],M=[],N=c.qHyperCube.qDimensionInfo[0].measureAxis.min,O=c.qHyperCube.qDimensionInfo[0].measureAxis.max,P=c.qHyperCube.qMeasureInfo[0].qMax<0?0:c.qHyperCube.qMeasureInfo[0].qMax,Q=c.qHyperCube.qMeasureInfo[0].qMin,R=c.qHyperCube.qMeasureInfo.length-1,S=c.qHyperCube.qMeasureInfo[R].qMax,T=c.qHyperCube.qMeasureInfo[R].qMin,U=c.qHyperCube.qDimensionInfo[0].measureAxis.minMax;if("minMax"===U&&N>O){var V=N;N=O,O=V}c.qHyperCube.qDimensionInfo[0].measureAxis.autoMinMax||"auto"===U?(M.push(P),L.push(Q),""!==B.trend.targetChartType&&c.qHyperCube.qMeasureInfo.length>1&&(M.push(S),L.push(T))):"min"===U?(L.push(N),M.push(P),""!==B.trend.targetChartType&&c.qHyperCube.qMeasureInfo.length>1&&M.push(S)):"max"===U?(M.push(O),L.push(Q),""!==B.trend.targetChartType&&c.qHyperCube.qMeasureInfo.length>1&&L.push(T)):"minMax"===U&&(L.push(N),M.push(O)),K.domain([e.min(L),e.max(M)]),c.qHyperCube.qDimensionInfo[0].measureAxis.autoMinMax&&K.nice(),d.$scope.scales.x=J,d.$scope.scales.xBar=H,d.$scope.scales.y=K;var W=0;K.domain()[0]>0&&K.domain()[1]>0?W=K.domain()[0]:K.domain()[0]<0&&K.domain()[1]<0&&(W=K.domain()[1]);var X=e.area().defined(function(a){return"NaN"!==a.y.value}).curve(e.curveLinear).x(function(a){return J(a.x.text)}).y0(K(W)).y1(function(a){return K(a.y.value)}),Y=e.line().defined(function(a){return"NaN"!==a.y.value}).curve(e.curveLinear).x(function(a){return J(a.x.text)}).y(function(a){return K(a.y.value)}),Z=G.selectAll(".trendchart__series").data(function(a){return a}).enter().append("g").attr("class",function(a){return"trendchart__series trendchart__series--"+a.id});Z.filter(function(a){return"line"===a.type}).append("path").attr("class","trendchart__line").attr("d",function(a){return Y(a.values)}).style("stroke",function(a){return a.color}).style("stroke-opacity",function(a){return a.opacity}).style("fill","none"),Z.filter(function(a){return a.showDatapoints}).selectAll("g.trendchart__circles").data(function(a){return[a]}).enter().append("g").attr("class","trendchart__circles").selectAll("marker").data(function(a){return a.values}).enter().filter(function(a){return"NaN"!==a.y.value}).append("circle").attr("class","trendchart__circle").attr("r",4).attr("cx",function(a){return J(a.x.text)}).attr("cy",function(a){return K(a.y.value)}).style("fill",function(a){return a.colorMarker}),Z.filter(function(a){return"area"===a.type}).append("path").attr("class","trendchart__area").attr("d",function(a){return X(a.values)}).style("fill",function(a){return a.color}),Z.filter(function(a){return"bar"===a.type}).selectAll("g.trendchart__bars").data(function(a){return[a]}).enter().append("g").attr("class","trendchart__bars").selectAll("bar").data(function(a){return a.values}).enter().filter(function(a){return"NaN"!==a.y.value}).append("rect").attr("class","trendchart__bar").attr("x",function(a){return H(a.x.text)}).attr("width",H.bandwidth()).attr("y",function(a){return K(Math.max(0,a.y.value))}).attr("height",function(a){return Math.abs(K(a.y.value)-K(0))}).style("fill",function(a){return a.color});var $=e.select("body").selectAll("div.cl-tooltip").data(["tooltip"]);$.enter().append("div").attr("class","cl-tooltip").style("opacity",0),$.exit().remove(),d.$scope.tooltip=e.select("body").select("div.cl-tooltip"),e.select(a.get(0)).select(".kpi-interaction-layer").on("mouseover",function(){d.$scope.options.showTooltip&&(d.$scope.tooltip.transition().style("opacity",.9),d.$scope.updateTooltip({x:e.mouse(this)[0],y:e.mouse(this)[1]},{x:e.event.pageX,y:e.event.pageY},"bar"===B.trend.chartType?H:J,K))}).on("mousemove",function(){d.$scope.options.showTooltip&&d.$scope.updateTooltip({x:e.mouse(this)[0],y:e.mouse(this)[1]},{x:e.event.pageX,y:e.event.pageY},"bar"===B.trend.chartType?H:J,K)}).on("mouseout",function(){d.$scope.options.showTooltip&&d.$scope.tooltip.transition().style("opacity",0)})}d.$scope.options=B}}});